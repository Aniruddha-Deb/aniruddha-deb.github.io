
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://aniruddhadeb.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://aniruddhadeb.com/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">


    <link href="https://aniruddhadeb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Aniruddha Deb Atom">

    <link href="https://aniruddhadeb.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Aniruddha Deb RSS">


<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79245932-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js' type='text/javascript'></script>  

<meta name="author" content="Aniruddha Deb" />
<meta name="description" content="The Basics The most basic boot process is BIOS on a standard i386/x86-64 device. The BIOS first detects the CPU/RAM, then initializes the remainder of the hardware, and then begins the boot sequence. The boot sequence basically consists of finding a bootable device, loading the boot program in …" />
<meta name="keywords" content="Programming">

<meta property="og:site_name" content="Aniruddha Deb"/>
<meta property="og:title" content="Bootloader Deep Dive"/>
<meta property="og:description" content="The Basics The most basic boot process is BIOS on a standard i386/x86-64 device. The BIOS first detects the CPU/RAM, then initializes the remainder of the hardware, and then begins the boot sequence. The boot sequence basically consists of finding a bootable device, loading the boot program in …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://aniruddhadeb.com/articles/2022/boot-deep-dive.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2022-12-03 05:00:00+05:30"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://aniruddhadeb.com/author/aniruddha-deb.html">
<meta property="article:section" content="Programming"/>
<meta property="article:tag" content="Programming"/>
<meta property="og:image" content="/extras/sitelogo.png">

  <title>Aniruddha Deb &ndash; Bootloader Deep Dive</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://aniruddhadeb.com">
        <img src="/extras/sitelogo.png" alt="" title="">
      </a>
      <h1><a href="https://aniruddhadeb.com"></a></h1>


      <nav>
        <ul class="list">
          <li><a href="https://aniruddhadeb.com/pages/about.html#about">About</a></li>
          <li><a href="https://aniruddhadeb.com/pages/feeds.html#feeds">Feeds</a></li>

          <li><a href="/archives.html">archives</a></li>
          <li><a href="/categories">categories</a></li>
          <li><a href="/tags">tags</a></li>
          <li><a href="https://www.cse.iitd.ac.in/~cs1200869">website</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://www.github.com/Aniruddha-Deb" target="_blank"><i class="fab fa-github"></i></a></li>
        <li><a class="sc-stack-exchange" href="https://stackexchange.com/users/12827944/aniruddha-deb" target="_blank"><i class="fab fa-stack-exchange"></i></a></li>
        <li><a class="sc-goodreads-g" href="https://www.goodreads.com/aniruddhadeb" target="_blank"><i class="fab fa-goodreads-g"></i></a></li>
        <li><a class="sc-envelope-o" href="mailto:aniruddha.deb.2002@gmail.com" target="_blank"><i class="fas fa-envelope"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="boot-deep-dive">Bootloader Deep Dive</h1>
    <p>
          Posted on Sat 03 December 2022 in <a href="https://aniruddhadeb.com/category/programming.html">Programming</a>


    </p>
  </header>


  <div>
    <h2>The Basics</h2>
<p>The most basic boot process is BIOS on a standard i386/x86-64 device. The BIOS
first detects the CPU/RAM, then initializes the remainder of the hardware, and
then begins the boot sequence. The boot sequence basically consists of finding 
a bootable device, loading the boot program in that bootable device into the 
processor cache and letting the processor do it's thing.</p>
<p>How is a bootable device found? A device is considered bootable if it has the 
magic bytes <code>0x55</code> and <code>0xaa</code> at offsets 511 and 512 from the start. This block
is called the <em>boot block</em> or <em>master boot record</em> (MBR), and this is what
kicks off the boot process. </p>
<p>The MBR looks something like this: </p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>sensei@manjaro-vm<span class="w"> </span>temp<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/sda<span class="w"> </span><span class="nv">of</span><span class="o">=</span>mbr.bin<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">512</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span>
<span class="m">1</span>+0<span class="w"> </span>records<span class="w"> </span><span class="k">in</span>
<span class="m">1</span>+0<span class="w"> </span>records<span class="w"> </span>out
<span class="m">512</span><span class="w"> </span>bytes<span class="w"> </span>copied,<span class="w"> </span><span class="m">0</span>.00493179<span class="w"> </span>s,<span class="w"> </span><span class="m">104</span><span class="w"> </span>kB/s
<span class="o">[</span>sensei@manjaro-vm<span class="w"> </span>temp<span class="o">]</span>$<span class="w"> </span>hexdump<span class="w"> </span>mbr.bin<span class="w"> </span>
<span class="m">0000000</span><span class="w"> </span>63eb<span class="w"> </span><span class="m">0090</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span>
<span class="m">0000010</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span>
*
<span class="m">0000050</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">8000</span><span class="w"> </span><span class="m">0001</span><span class="w"> </span><span class="m">0000</span>
<span class="m">0000060</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span>faff<span class="w"> </span><span class="m">9090</span><span class="w"> </span>c2f6<span class="w"> </span><span class="m">7480</span><span class="w"> </span>f605<span class="w"> </span>70c2
...
...
00001c0<span class="w"> </span><span class="m">0021</span><span class="w"> </span>fe83<span class="w"> </span>ffff<span class="w"> </span><span class="m">0800</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span>f026<span class="w"> </span>01df<span class="w"> </span><span class="m">0000</span>
00001d0<span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span>
*
00001f0<span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span><span class="m">0000</span><span class="w"> </span>aa55
</code></pre></div>

<p><code>dd</code> copies the first 512 bytes of my disk to a binary called <code>mbr.bin</code>, and 
we hexdump it's contents. Note the <code>0x55</code> and <code>0xaa</code> magic bytes right at the 
end (the system is little endian, so it reads as <code>aa55</code>). These 512 bytes tell 
the system to load in GRUB, which then begins the boot process.</p>
<h2>GRUB</h2>
<p>The GRand Unified Bootloader is the default bootloader on Linux systems. What 
GRUB does is create a basic runtime, initializes the ramdisk and finally loads 
the kernel in. GRUB is launched by those 512 bytes that we saw above. The
actual GRUB files are stored in <code>/boot/grub</code>, and they look like this:</p>
<div class="highlight"><pre><span></span><code>/boot/grub
├──<span class="w"> </span>fonts
│<span class="w">   </span>└──<span class="w"> </span>unicode.pf2
├──<span class="w"> </span>grub.cfg
├──<span class="w"> </span>grubenv
├──<span class="w"> </span>i386-pc
│<span class="w">   </span>├──<span class="w"> </span>acpi.mod
│<span class="w">   </span>├──<span class="w"> </span>adler32.mod
│<span class="w">   </span>│<span class="w">   </span>...
│<span class="w">   </span>│<span class="w">   </span>...
│<span class="w">   </span>└──<span class="w"> </span>zstd.mod
├──<span class="w"> </span>locale
│<span class="w">   </span>├──<span class="w"> </span>ast.mo
│<span class="w">   </span>├──<span class="w"> </span>ca.mo
│<span class="w">   </span>│<span class="w">   </span>...
│<span class="w">   </span>│<span class="w">   </span>...
│<span class="w">   </span>└──<span class="w"> </span>zh_TW.mo
└──<span class="w"> </span>themes
<span class="w">    </span>└──<span class="w"> </span>starfield
<span class="w">        </span>├──<span class="w"> </span>blob_w.png
<span class="w">        </span>│<span class="w">   </span>...
<span class="w">        </span>│<span class="w">   </span>...
<span class="w">        </span>└──<span class="w"> </span>theme.txt
</code></pre></div>

<p>What GRUB does is essentially create a 'mini 32-bit linux OS', with debug
environments, a shell, and a lot of creature comforts, but beyond all that, it 
creates the RAMFS and loads the kernel and points it to the RAMFS. This can be 
seen in the <code>grub.cfg</code> file:</p>
<div class="highlight"><pre><span></span><code>menuentry<span class="w"> </span><span class="s1">&#39;Manjaro Linux&#39;</span><span class="w"> </span>--class<span class="w"> </span>manjaro<span class="w"> </span>--class<span class="w"> </span>gnu-linux<span class="w"> </span>--class<span class="w"> </span>gnu<span class="w"> </span>--class<span class="w"> </span>os<span class="w"> </span><span class="nv">$menuentry_id_option</span><span class="w"> </span><span class="s1">&#39;gnulinux-simple-ffd2d1d7-a3e5-4e24-816d-d83f13c56708&#39;</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>savedefault
<span class="w">    </span>load_video
<span class="w">    </span>...
<span class="w">    </span>...
<span class="w">    </span>linux<span class="w">   </span>/boot/vmlinuz-5.15-x86_64<span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>ffd2d1d7-a3e5-4e24-816d-d83f13c56708<span class="w"> </span>rw<span class="w">  </span>quiet<span class="w"> </span>udev.log_priority<span class="o">=</span><span class="m">3</span>
<span class="w">    </span>initrd<span class="w">  </span>/boot/intel-ucode.img<span class="w"> </span>/boot/initramfs-5.15-x86_64.img
<span class="o">}</span>
</code></pre></div>

<p>Note the last two lines: here we're specifying the actual linux kernel image
using the <code>linux</code> command, and the files that initialize the RAMFS using <code>initrd</code>.
(The <code>intel-ucode.img</code> is a bunch of microcode patches that the OS loads in to 
workaround hardware-level bugs, think heartbleed, spectre etc. It's super 
important to load this in before anything else, so that the boot process may 
not be compromised and so on.)</p>
<h2>What's a RAMFS</h2>
<p>A RAM file system (or RAM disk) is, quite simply, a file system in memory! When 
the system needs to boot, the files for the system may not simply be on the 
HDD/SSD: they can be somewhere on the network (PXE boot), on a removable media 
(USB,CDROM) or on an encrypted drive! (BootLocker equivalents on Linux). For 
all this, we need a temporary file system that the kernel can run off of to
load the OS into actual memory.</p>
<p>Another reason for a RAMFS is that the Linux kernel is neither monolithic, nor 
a microkernel: it's somewhere in between in the sense that you can load modules 
into the kernel while it's running. To do the stuff that we've described above,
(Boot off of the network, decrypt an encrypted drive, etc), the relevant kernel 
modules will need to be loaded into the kernel first. These generally reside in 
the initramfs image, and are loaded into memory by the kernel. <code>initramfs</code> is 
generally a <code>cpio</code> compressed image, which is decompressed when it's loaded in 
(something that GRUB does), and this is generated using the <code>mkinitcpio</code> command, 
after specifying the default modules and hooks (for more information, check 
out <a href="https://nickdesaulniers.github.io/blog/2018/10/24/booting-a-custom-linux-kernel-in-qemu-and-debugging-it-with-gdb/">This great resource</a>
which boots a Linux Kernel from scratch in QEMU)</p>
<h2>From Kernel to Login Screen</h2>
<p>Once the Kernel has finally loaded all the modules from the RAMFS and entrenched 
itself in memory, it calls <code>/init</code> in the RAMFS to finally load the disk and 
all other modules from disk.</p>
<p>It's all downhill from here: once all modules have been loaded, <code>systemd</code> (or 
<a href="https://nosystemd.org/">Your favourite Init Daemon</a>) is called, which starts 
as PID 1 and spawns all relevant processes on the system. <code>systemd</code> will then 
start LightDM (On Manjaro, you might have a different Desktop Manager), which 
displays your login prompt, and you can now finally login!</p>
<p><img alt="image of a login screen" src="res/manjaro_cinnamon.png"></p>
<p>Unless, of course, you've locked yourself out with too many failed password 
attempts</p>
<h2>Is this process standard across systems?</h2>
<p>Nope. Atleast, not when you change architectures. Or go to UEFI. Ah, let's just 
say this is very specific.</p>
<p>I bumped into this whole process as I wanted to do some kernel hacking on my 
faithful <a href="https://aniruddhadeb.com/articles/2022/arch-linux-1.html">Raspberry Pi</a>.
I regret to inform all Pi hackers that the bootloader process for the Pi is 
<a href="https://raspberrypi.stackexchange.com/questions/10442/what-is-the-boot-sequence/10595#10595">completely different</a>,
and much easier, and all you have to do is place your kernel image with the 
appropriate name in the '/boot' directory and the Pi will boot from it.</p>
<p>TL;DR the Pi has a two (three?) stage bootloader, which curiously completely 
runs on the GPU. The only time the CPU is actually used is when the kernel image 
is loaded into memory, and the actual init process starts. The bootloaders are 
<code>.elf</code> files, and are apparently proprietrary. I'll give decompiling them a 
shot if I have free time, but I think someone would already have tried that out.</p>
<p>On a side note, embedded systems with limited memory and a fairly fixed device 
layout generally boot without a RAMFS, as there's simply no need to hotload a 
bunch of modules into the linux kernel, when you know exactly what modules you'll 
need and what the hardware arrangement (where you're going to boot from) is.</p>
<p>Happy Hacking!</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://aniruddhadeb.com/tag/programming.html">Programming</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'aniruddha-deb';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Aniruddha Deb ",
  "url" : "https://aniruddhadeb.com",
  "image": "/extras/sitelogo.png",
  "description": ""
}
</script>

</body>
</html>